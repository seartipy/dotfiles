colorize() {
    if [ -t 1 ]; then
        printf "\e[%sm%s\e[m" 1 "$2"
    else
        echo -n "$2"
    fi
}

log() {
    echo $1 >> ~/seartipy-installer.log
}

warn() {
    colorize "WARNING : "
    echo $1
}

err_exit() {
    colorize "FATAL: "
    echo $1
    exit 1
}

is_ubuntu() {
    has_cmd lsb_release || return 1
    local os=`echo $(lsb_release -i | cut -d ':' -f2)`
    [[ "Ubuntu" == "$os" ]] || return 1
}

is_fedora() {
    [ -f /etc/redhat-release ] || return 1
}

is_linux() {
    [ "$OSTYPE" == "linux-gnu" ] || return 1
}

is_mac() {
    [[ "$OSTYPE" == "darwin"* ]] || return 1
}

has_cmd() {
    command -v $1 > /dev/null
}

smv() {
    mv $1 $2 2> /dev/null
}

smd() {
    [ -d "$1" ] || mkdir -p "$1" 2> /dev/null
}

srm() {
    $trash $1 $2
}

sln() {
    if ! [ -e "$1" ]; then
        warn "$1 does not exist, cannot create the link $2"
    elif [ -L "$2" ]; then
        srm "$2"
    elif [ -e "$2" ]; then
        warn "$2 exists and not a symbolic link! not creating link"
        return
    fi
    ln -s $1 $2 2> /dev/null
}

sclone() {
    if ! [ -d "$2" ]; then
        log "Cloning $1 to $2"
        git clone $1 $2
    fi
}

pre_cmd_check() {
    has_cmd "$1" || err_exit "$1 not installed"
}

cmd_check() {
    has_cmd "$1" || warn "$1 not installed"
}

pre_dir_check() {
    [ -d "$1" ] || err_check  "$1 directory does not exist"
}

dir_check() {
    [ -d "$1" ] || warn "$1 directory does not exist"
}

ln_check() {
    local rl=readlink
    if is_mac; then
        rl=greadlink
    fi

     [[ $($rl -f $2) == "$1" ]] ||  warn "$2 not a link to $1"
}

brew_install() {
    if ! has_cmd brew; then
        cmd_check ruby

        log "Installing homebrew"
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi

    if ! has_cmd brew; then
        err_exit "could not install brew, quitting"
    fi

    log "Installing brew cask"
    brew install caskroom/cask/brew-cask

    log "Tapping emacsport"
    [ -n "$EMACS" ] && brew tap railwaycat/emacsmacport

    log "Upgrading brew packages"
    brew update && brew upgrade
}

mac_packages_install() {
    brew_install

    log "Installing all packages, this will take a while..."
    brew install wget trash tree fasd unrar p7zip gpg the_silver_searcher coreutils tmux gibo gpg
    brew cask install iterm2

    if [ -n "$EMACS" ]; then
        log "Installing emacs packages"
        brew install emacs-mac ---with-spacemacs-icon
        brew install editorconfig cask
        # TODO : ctags
        brew install aspell --with-lang-en
    fi

    if [ -n "$VIM" ]; then
        log "Installing vim packages"
        brew install macvim --override-system-vim --with-lua --with-luajit
        brew linkapps macvim
    fi

    if [ -n "$GIT" ]; then
        log "Installing git packages"
        brew cask install smartgit
        brew install kdiff3 git-extras
    fi

    if [ -n "$HASKELL" ]; then
        log "Installing haskell packages"
        brew install ghc cabal-install haskell-stack
        brew cask install elm-platform idris purescript
    fi

    if [ -n "$SCALA" ] || [ -n "$CLOJURE" ]; then
        log "Installing java"
        brew cask install java caskroom/homebrew-versions/java6 intellij-idea
    fi

    if [ -n "$PYTHON" ]; then
        log "Installing python packages"
        brew install pyenv pyenv-virtualenv homebrew/boneyard/pyenv-pip-rehash
    fi

    if [ -n "$SCALA" ]; then
        log "Installing scala packages"
        brew install sbt scala
        brew cask install scala-ide
    fi

    if [ -n "$CLOJURE" ]; then
        log "Installing clojure packages"
        brew install leiningen boot-clj
    fi

    if [ -n "$WEB" ]; then
        log "Installing web packages"
        brew install node flow
        brew cask install webstorm
    fi

    if [ -n "$CPP" ]; then
        log "Installing c++ packages"
        brew install boost --c++11
        brew install cmake scons boost-build cppcheck
        brew cask install clion
    fi

    if [ -n "$ELIXIR" ]; then
        log "Installing elixir"
        brew install elixir
    fi

    if [ -n "$ADDITIONAL" ]; then
        log "Installing additional packages"
        brew cask install atom google-chrome dash android-file-transfer virtualbox transmission macdown github-desktop sublime-text3 vlc karabiner seil spectacle skype gitup discord amethyst
        brew cask install betterzipql qlcolorcode qlimagesize qlmarkdown qlprettypatch qlstephen quicklook-csv quicklook-json suspicious-package webpquicklook xquartz
        brew install youtube-dl
    fi

    log "cleanup brew"
    brew cleanup
    brew cask cleanup
}

add_java_ppa() {
    if ! ls /etc/apt/sources.list.d | grep webupd8team-ubuntu-java > /dev/null; then
        log "Adding java ppa"
        echo "oracle-java8-installer shared/accepted-oracle-license-v1-1 select true" | sudo debconf-set-selections
        sudo add-apt-repository ppa:webupd8team/java -y
    fi
}

add_scala_ppa() {
    if ! ls /etc/apt/sources.list.d | grep sbt > /dev/null; then
        log "Adding scala ppa"
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 642AC823
        echo "deb http://dl.bintray.com/sbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
    fi
}

add_smartgit_ppa() {
    if ! ls /etc/apt/sources.list.d | grep eugenesan-ubuntu-ppa > /dev/null; then
        log "Adding smartgit ppa"
        sudo add-apt-repository ppa:eugenesan/ppa -y
    fi
}

add_haskell_stack_ppa() {
    if ! ls /etc/apt/sources.list.d | grep fpco > /dev/null; then
        log "Adding stack ppa"
        wget -q -O- https://s3.amazonaws.com/download.fpcomplete.com/ubuntu/fpco.key | sudo apt-key add -
        echo 'deb http://download.fpcomplete.com/ubuntu/wily stable main'|sudo tee /etc/apt/sources.list.d/fpco.list
    fi
}

add_ghc_ppa() {
    if ! ls /etc/apt/sources.list.d | grep hvr-ubuntu-ghc > /dev/null; then
        log "Adding ghc ppa"
        sudo add-apt-repository ppa:hvr/ghc -y
    fi
}

add_zeal_ppa() {
    if ! ls /etc/apt/sources.list.d | grep zeal-developers-ubuntu > /dev/null; then
        log "Adding zeal ppa"
        sudo add-apt-repository ppa:zeal-developers/ppa -y
    fi
}

add_chrome_ppa() {
    if ! ls /etc/apt/sources.list.d | grep google.list > /dev/null; then
        log "Adding google chrome ppa"
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
    fi
}

add_webupd8_ppa() {
    if ! ls /etc/apt/sources.list.d | grep nilarimogard-ubuntu-webupd8 > /dev/null; then
        log "Adding webupd8 ppa for youtub-dl etc"
        sudo add-apt-repository  ppa:nilarimogard/webupd8 -y
    fi
}

add_virtualbox_ppa() {
    if ! has_cmd vmware-user-suid-wrapper; then
        log "Adding virtualbox ppa"
        if ! grep download.virtualbox.org/virtualbox/debian /etc/apt/sources.list > /dev/null; then
            wget -q https://www.virtualbox.org/download/oracle_vbox.asc -O- | sudo apt-key add -
            sudo sh -c 'echo "deb http://download.virtualbox.org/virtualbox/debian vivid contrib" >> /etc/apt/sources.list'
        fi
    fi
}

add_sublime_ppa() {
    if ! ls /etc/apt/sources.list.d | grep webupd8team-ubuntu-sublime-text-3 > /dev/null; then
        log "Adding sublime ppa"
        sudo add-apt-repository ppa:webupd8team/sublime-text-3 -y
    fi
}

add_atom_ppa() {
        if ! ls /etc/apt/sources.list.d | grep webupd8team-ubuntu-atom > /dev/null; then
        log "Adding atom ppa"
        sudo add-apt-repository  ppa:webupd8team/atom -y
    fi
}

add_docker_ppa() {
    if ! has_cmd vmware-user-suid-wrapper && ! ls /etc/apt/sources.list.d | grep docker > /dev/null; then
        log "Installing docker"
        wget -qO- https://get.docker.com/ | sh
        sudo usermod -aG docker $USER
    fi
}

add_additional_ppas() {
    # add_zeal_ppa
    add_atom_ppa
    add_sublime_ppa
    add_virtualbox_ppa
    add_docker_ppa
    add_chrome_ppa
    add_webupd8_ppa
    add_smartgit_ppa
}

add_ppas() {
    pre_cmd_check debconf-set-selections
    pre_cmd_check add-apt-repository
    pre_cmd_check apt-key

    if [ -n "$SCALA" ] || [ -n "$CLOJURE" ]; then
        add_java_ppa
    fi
    [ -n "$SCALA" ] && add_scala_ppa
    [ -n "$GIT" ] && add_smartgit_ppa
    # [ -n "$HASKELL" ] && add_ghc_ppa
    [ -n "$HASKELL" ] && add_haskell_stack_ppa

    [ -n "$ADDITIONAL" ] && add_additional_ppas

    log "Updating ubuntu"
    if ! sudo apt-get update; then
        err_exit "apt-get update failed, quitting"
    fi

    log "Upgrading packages"
    if ! sudo apt-get upgrade -y; then
        err_exit "apt-get upgrade failed, quitting"
    fi
}

fedora_packages_install() {
    pre_cmd_check dnf

    log "Add rpmfusion free and non free packages"
    sudo dnf install -y http://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm http://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

    log "Installing all packages, this will take a while"
    sudo dnf install -y curl wget git trash-cli tree xsel xclip the_silver_searcher unrar p7zip dconf tmux exfat-utils

    if [ -n "$EMACS" ]; then
        log "Installing emacs"
        sudo dnf install -y emacs aspell aspell-en ctags-etags
    fi

    if [ -n "$ZSH" ]; then
        log "Installing zsh"
        sudo dnf install -y zsh
    fi

    if [ -n "$GIT" ]; then
        log "Installing git"
        sudo dnf install -y kdiff3 git-extras meld
    fi

    if [ -n "$SCALA" ] || [ -n "$CLOJURE" ]; then
        log "Installing java"
        sudo dnf install -y java-1.8.0-openjdk java-1.8.0-openjdk-src
    fi

    if [ -n "$SCALA" ]; then
        log "Installing scala"
        curl https://bintray.com/sbt/rpm/rpm | sudo tee /etc/yum.repos.d/bintray-sbt-rpm.repo
        sudo dnf install -y scala sbt
    fi

    if [ -n "$HASKELL" ]; then
        log "Installing haskell"
        sudo dnf install -y ghc cabal-install
        sudo dnf copr -y enable petersen/stack
        sudo dnf install -y stack
    fi

    if [ -n "$VIM" ]; then
        log "Installing vim"
        sudo dnf install -y vim-enhanced
    fi

    if [ -n "$CPP" ]; then
        log "Installing C++"
        sudo dnf install -y clang clang-devel clang-analyzer clang-libs boost boost-build  gcc-c++ cppcheck scons cmake
    fi

    if [ -n "$ELIXIR" ]; then
        log "Installing elixir"
        sudo dnf install -y elixir
    fi

    if [ -n "$ADDITIONAL" ]; then
        log "Installing additional packages"
        sudo dnf install -y vlc youtube-dl
        if ! has_cmd vmware-user-suid-wrapper; then
            sudo dnf install -y VirtualBox dkms
        fi
    fi

    if [ -n "$XMONAD" ]; then
        log "Installing xmonad"
        sudo dnf install -y xmonad ghc-xmonad-contrib xmonad-mate ghc-xmonad-devel ghc-xmonad-contrib-devel xmobar stalonetray dmenu scrot cabal-install xcompmgr
    fi

    sudo dnf clean all
}

ubuntu_packages_install() {
    pre_cmd_check apt-get
    add_ppas

    log "Installing all packages, this will take a while"
    sudo apt-get install -y curl wget git trash-cli tree xsel xclip silversearcher-ag unrar p7zip dconf-cli build-essential chromium-browser tmux exfat-fuse exfat-utils linux-headers-`uname -r`

    if [ -n "$EMACS" ]; then
        log "Installing emacs"
        sudo apt-get install -y emacs24 aspell aspell-en editorconfig exuberant-ctags
    fi
    if [ -n "$ZSH" ]; then
        log "Installing zsh"
        sudo apt-get install -y zsh
    fi

    if [ -n "$GIT" ]; then
        log "Installing git"
        sudo apt-get install -y smartgit kdiff3 git-extras meld
    fi

    if [ -n "$SCALA" ] || [ -n "$CLOJURE" ]; then
        log "Installing Java"
        sudo apt-get install -y oracle-java8-installer oracle-java8-set-default
    fi

    if [ -n "$SCALA" ]; then
        log "Install scala"
        sudo apt-get -y install sbt
    fi

    if [ -n "$HASKELL" ]; then
        log "Installing haskell"
        sudo apt-get install -y stack
        sudo apt-get install -y cabal-install ghc
    fi

    if [ -n "$VIM" ]; then
        log "Installing vim"
        sudo apt-get install -y vim-gnome
    fi

    if [ -n "$CPP" ]; then
        log "Installing C++"
        sudo apt-get install -y clang libclang-dev libc++-dev libc++abi-dev libboost-all-dev g++ cppcheck scons cmake
    fi

    if [ -n "$ADDITIONAL" ]; then
        log "Installing additional"
        sudo apt-get install -y vlc youtube-dl sublime-text-installer atom google-chrome-stable
        if ! has_cmd vmware-user-suid-wrapper; then
            sudo apt-get install -y virtualbox-5.0 dkms
        fi
    fi

    if [ -n "$XMONAD" ]; then
        log "Installing xmonad"
        sudo apt-get install -y xmonad libghc-xmonad-contrib-dev xmobar stalonetray suckless-tools scrot cabal-install xcompmgr
    fi

    if [ -n "$ELIXIR" ]; then
        log "Installing elixir"
        sudo apt-get install -y elixir
    fi

    sudo apt-get clean
}

packages_install() {
    if is_ubuntu; then
        ubuntu_packages_install
    elif is_fedora; then
        fedora_packages_install
    elif is_mac; then
        mac_packages_install
    else
        err_exit "Unknown OS, quitting"
    fi
}

spacemacs_dotfiles() {
    sclone https://github.com/syl20bnr/spacemacs ~/seartipy/emacses/spacemacs
    log "Linking ~/seartipy/dotfiles/spacemacs as ~/.spacemacs"
    sln ~/seartipy/dotfiles/spacemacs ~/.spacemacs
}

leanemacs_dotfiles() {
    if [ -f ~/seartipy/lean-dotfiles/emacs-init.el ]; then
        log "Moving ~/seartipy/emacses/lean-emacs to $BACKUP_DIR (if it exists)"
        smv ~/seartipy/emacses/lean-emacs $BACKUP_DIR

        smd ~/seartipy/emacses/lean-emacs

        log "Linking ~/seartipy/lean-dotfiles/emacs-init.el as ~/seartipy/emacses/lean-emacs/init.el"
        sln ~/seartipy/lean-dotfiles/emacs-init.el ~/seartipy/emacses/lean-emacs/init.el
    else
        warn "~/seartipy/lean-dotfiles/emacs-init.el does not exist, skipping emacs lean dotfiles"
    fi
}

housemd_dotfiles() {
    sclone  https://github.com/pervezfunctor/emacs.d ~/seartipy/emacses/housemd
    if [ -d "$HOME/seartipy/emacses/housemd" ]; then
        log "Moving ~/.emacs.d to $BACKUP_DIR (if they exist) "
        smv ~/.emacs.d $BACKUP_DIR

        log "Linking ~/seartipy/emacses/housemd as ~/.emacs.d"
        sln ~/seartipy/emacses/housemd ~/.emacs.d
    else
        warn "~/seartipy/emacses/housemd does not exist, skipping housemd dotfiles"
    fi
}

emacs_dotfiles() {
    spacemacs_dotfiles
    leanemacs_dotfiles
    housemd_dotfiles
}

boot_dotfiles() {
    if [ -f ~/seartipy/dotfiles/boot-profile.boot ]; then
        log "Moving ~/.boot/profile.boot to $BACKUP_DIR (if exists)"
        smv ~/.boot/profile.boot $BACKUP_DIR

        smd ~/.boot

        log "Linking ~/seartipy/dotfiles/boot-profile.boot as ~/.boot/profile.boot"
        sln ~/seartipy/dotfiles/boot-profile.boot ~/.boot/profile.boot
    else
        warn "~/seartipy/dotfiles/boot-profile.boot does not exist. skipping linking"
    fi
}

lein_dotfiles() {
    if [ -f ~/seartipy/dotfiles/lein-profiles.clj ]; then
        log "Moving ~/.lein/profiles.clj to $BACKUP_DIR (if exists)"
        smv ~/.lein/profiles.clj $BACKUP_DIR

        smd ~/.lein

        log "Linking ~/seartipy/dotfiles/lein-profiles.clj as ~/.lein/profiles.clj"
        sln ~/seartipy/dotfiles/lein-profiles.clj ~/.lein/profiles.clj
    else
        warn "~/seartipy/dotfiles/lein-profiles.clj does not exist. skipping linking"
    fi
}

clojure_dotfiles() {
    lein_dotfiles
    boot_dotfiles
}

scala_dotfiles() {
    if [ -f ~/seartipy/dotfiles/sbt-plugins.sbt ]; then
        log "Moving ~/.sbt/0.13/plugins/plugins.sbt to $BACKUP_DIR (if exists)"
        smv ~/.sbt/0.13/plugins/plugins.sbt $BACKUP_DIR

        smd ~/.sbt/0.13/plugins

        log "Linking ~/seartipy/dotfiles/sbt-plugins.sbt as ~/.sbt/0.13/plugins/plugins.sbt"
        sln ~/seartipy/dotfiles/sbt-plugins.sbt ~/.sbt/0.13/plugins/plugins.sbt
    else
        warn "~/seartipy/dotfiles/sbt-plugins.sbt does not exist. skipping linking"
    fi

    if [ -f ~/seartipy/dotfiles/sbt-global.sbt ]; then
        log "Moving ~/.sbt/0.13/global.sbt to $BACKUP_DIR (if exists)"
        smv ~/.sbt/0.13/global.sbt $BACKUP_DIR

        smd ~/.sbt/0.13/

        log "Linking ~/seartipy/dotfiles/sbt-global.sbt as ~/.sbt/0.13/global.sbt"
        sln ~/seartipy/dotfiles/sbt-global.sbt ~/.sbt/0.13/global.sbt
    else
        warn "~/seartipy/dotfiles/sbt-global.sbt does not exist. skipping linking"
    fi
}

zsh_dotfiles() {
    if [ -f ~/seartipy/dotfiles/zshrc ]; then
        log "Moving ~/.zshrc to $BACKUP_DIR "
        smv ~/.zshrc $BACKUP_DIR

        log "Linking ~/seartipy/dotfiles/zshrc as ~/.zshrc"
        sln ~/seartipy/dotfiles/zshrc ~/.zshrc
    else
        warn "~/seartipy/dotfiles/zhrc does not exist, skipping zsh dotfiles"
    fi
}

bash_dotfiles() {
    if [ -f ~/seartipy/dotfiles/bashrc ]; then
        log "Moving ~/.bash_profile to $BACKUP_DIR"
        smv ~/.bash_profile $BACKUP_DIR
        sln ~/seartipy/dotfiles/bashrc ~/.bash_profile

        if is_linux && ! grep .bash_profile ~/.bashrc > /dev/null; then
            echo "[ -f ~/.bash_profile ] && source ~/.bash_profile" >> ~/.bashrc
        fi
    else
        warn "~/seartipy/dotfiles/bashrc does not exist, skipping bash dotfiles"
    fi
}

tmux_dotfiles() {
    if [ -f ~/seartipy/dotfiles/tmux.conf ]; then
        log "Moving ~/.tmux.conf to $BACKUP_DIR"
        smv ~/.tmux.conf $BACKUP_DIR

        log "Linking ~/seartipy/dotfiles/tmux.conf to ~/.tmux.conf"
        sln ~/seartipy/dotfiles/tmux.conf ~/.tmux.conf
    else
        warn "~/seartipy/dotfiles/tmux.conf does not exist, skipping tmux dotfiles"
    fi
}

amethyst_dotfiles() {
    if [ -f ~/seartipy/dotfiles/amethyst ]; then
        log "Moving ~/.amethyst to $BACKUP_DIR"
        smv ~/.amethyst $BACKUP_DIR

        log "Linking ~/seartipy/dotfiles/amethyst to ~/.amethyst"
        sln ~/seartipy/dotfiles/amethyst ~/.amethyst
    else
        warn "~/seartipy/dotfiles/amethyst doesnt not exist, skipping amethyst dotfiles"
    fi
}

clone_lean_dotfiles() {
    log "Backing up your current lean-dotfiles(if exists) to $BACKUP_DIR"
    smv ~/seartipy/lean-dotfiles $BACKUP_DIR

    log "Cloning lean dotfiles"
    sclone https://perveziqbal@bitbucket.org/perveziqbal/lean-dotfiles.git ~/seartipy/lean-dotfiles
}

clone_dotfiles() {
    log "Backing up your current dotfiles(if exists) to $BACKUP_DIR"
    smv ~/seartipy/dotfiles $BACKUP_DIR

    log "Cloning dotfiles"
    sclone https://github.com/pervezfunctor/dotfiles.git ~/seartipy/dotfiles
}

dotfiles_install() {
    clone_dotfiles
    clone_lean_dotfiles

    [ -d "$HOME/seartipy/dotfiles" ] || err_exit "~/seartipy/dotfiles/ does not exist, quitting"

    if [ -n "$ZSH" ]; then
        zsh_dotfiles
        tmux_dotfiles
    fi
    [ -n "$BASH" ] && bash_dotfiles

    [ -n "$EMACS" ] && emacs_dotfiles

    [ -n "$CLOJURE" ] && clojure_dotfiles
    [ -n "$SCALA" ] && scala_dotfiles
    [ -n "$ADDITIONAL" ] && amethyst_dotfiles
}

liquidprompt_install() {
    sclone https://github.com/nojhan/liquidprompt.git ~/seartipy/vendors/liquidprompt
}

zsh_install() {
    sclone https://github.com/changs/slimzsh.git ~/.slimzsh
    sclone https://github.com/zsh-users/antigen.git ~/seartipy/vendors/antigen
    liquidprompt_install
}

bash_install() {
    liquidprompt_install
}

emacs_install() {
    if is_mac; then
        log "Trashing /Applications/Emacs.app alias (if exists)"
        srm '/Applications/Emacs.app alias'

        log "Creating Emacs alias in /Applications"
        # make emacs available from spotlight
        osascript -e 'tell application "Finder" to make alias file to POSIX file "/usr/local/opt/emacs-mac/Emacs.app" at POSIX file "/Applications"'

        log "Generating terminfo for terminal in emacs"
        local emacsversion=`ls /usr/local/Cellar/emacs-mac`
        tic -o ~/.terminfo /usr/local/Cellar/emacs-mac/${emacsversion}/share/emacs/24.5/etc/e/eterm-color.ti

    elif is_linux; then
        export PATH="$HOME/.cask/bin:$PATH"
	if ! has_cmd cask; then
	    curl -fsSL https://raw.githubusercontent.com/cask/cask/master/go | python
	fi
    fi

    if cd ~/seartipy/emacses/housemd; then
        if [ -n "$SEARTIPY" ]; then
            git checkout seartipy
        fi
        if has_cmd cask; then
            cask install && cask update
        else
            warn "cask command absent, skipping emacs install"
        fi
    else
        warn "~/seartipy/emacses/housemd does not exist, skipping emacs install"
    fi
}

lein_install() {
    if ! has_cmd lein; then
        log "Installing leiningen"
        curl -L https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein > ~/bin/lein
        chmod +x ~/bin/lein
    fi
}

boot_install() {
    if has_cmd boot; then
        boot -u
    else
        log "Installing boot"
        curl -L https://github.com/boot-clj/boot/releases/download/2.4.2/boot.sh > ~/bin/boot
        chmod a+x ~/bin/boot
    fi
}

clojure_install() {
    if is_linux; then
        if ! has_cmd javac; then
            warn "Java not installed, skipping clojure"
            return 1
        fi

        lein_install
        boot_install
    fi
}

purescript_install() {
    if is_linux; then
        nvm_install
        if ! has_cmd npm; then
            warn "npm not installed, cannot install elm"
            return 1
        fi
        log "Installing purescript"
        npm install -g purescript elm@0.15.1-beta4 # elm would release a final version for npm 3
    fi
}

idris_install() {
    if is_linux; then
        if ! has_cmd cabal; then
            warn "cabal not installed; cannot install idris"
            return 1
        fi
        cabal update
        log "Installing idris"
        cabal install idris
    fi
}

haskell_install() {
    purescript_install
    idris_install

    if ! has_cmd stack; then
        warn "stack not installed, skipping haskell install"
        return 1
    fi

    log "Installing stack packages"
    stack setup
    stack install alex
    stack install happy
    stack install hlint
    stack install structured-haskell-mode
    stack install stylish-haskell
    stack install hasktags
    stack install hindent
    stack install hdevtools
}

python_install() {
    if is_linux; then
        sclone  https://github.com/yyuu/pyenv.git ~/.pyenv
        sclone https://github.com/yyuu/pyenv-pip-rehash.git ~/.pyenv/plugins/pyenv-pip-rehash
        sclone https://github.com/yyuu/pyenv-virtualenv.git ~/.pyenv/plugins/pyenv-virtualenv
        export PYENV_ROOT="$HOME/.pyenv"
        export PATH="$PYENV_ROOT/bin:$PATH"
    fi

    if has_cmd pyenv; then
        if ! pyenv versions | grep anaconda > /dev/null; then
            log "Installing anaconda"
            local anacondaversion=`pyenv install --list | grep anaconda | tail -1`
            pyenv install $anacondaversion
        else
            warn "pyenv command does not exist, skipping python install"
        fi
    else
        warn "pyenv does not exists, skipping python install"
    fi
}

ruby_install() {
    if ! has_cmd rvm || ! rvm list rubies | grep "=* ruby"; then
        log "Installing rvm"
        gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
        curl -sSL https://get.rvm.io | bash -s stable --ruby
    fi

    source ~/.rvm/scripts/rvm
    log "Installing ruby gems"
    if is_mac; then
        gem install eventmachine -- --with-cppflags=-I/usr/local/opt/openssl/include
    fi
    gem install pry sinatra thin guard watchr tmuxinator git-up sass  --no-ri --no-rdoc
}

flow_install() {
    if ! has_cmd flow; then
        log "Installing flow"
        cd ~/seartipy/vendors
        wget https://facebook.github.io/flow/downloads/flow-linux64-latest.zip
        unzip -o flow-linux64-latest.zip
        srm flow-linux64-latest.zip
    fi
}

nvm_install() {
    log "Installing nvm"
    if ! has_cmd nvm; then
        curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.29.0/install.sh | bash
    fi

    source ~/.nvm/nvm.sh
    nvm install stable
    nvm alias default stable
}

web_install() {
    if is_linux; then
        nvm_install
        flow_install
    fi

    if ! has_cmd npm; then
        warn "npm not installed, skipping web install"
        return 1
    fi

    log "Installing npm packages for web development"
    npm install -g coffee-script typescript babel webpack karma-cli eslint jshint coffeelint tern js-beautify webpack-dev-server eslint-plugin-react babel-eslint browserify watchify babelify budo gulp grunt-cli
}

vim_install() {
    log "Installing vim packages"
    if ! [ -d ~/.spf13-vim-3 ]; then
        curl http://j.mp/spf13-vim3 -L -o - | sh
    fi
}

fasd_install() {
    if ! has_cmd make; then
        warn "make does not exist, skipping fasd installation"
        return 1
    fi

    if ! has_cmd fasd; then
        log "Installing fasd"
        if git clone https://github.com/clvv/fasd.git ~/seartipy-installer-fasd; then
            cd ~/seartipy-installer-fasd && PREFIX=$HOME make install
            srm ~/seartipy-installer-fasd
        else
            warn 'could not clone fasd, skipping fasd installation'
        fi
    fi
}

gibo_install() {
    if ! has_cmd gibo; then
        log "Installing gibo"
        curl -L https://raw.github.com/simonwhitaker/gibo/master/gibo -so ~/bin/gibo
        chmod +x ~/bin/gibo
	gibo -u
    fi
}

sourcecodepro_install() {
    if has_cmd fc-cache; then
        warn "fc-cache command does not exist, skipping source code pro fonts installation"
    fi

    if ! ls ~/.fonts | grep SourceCodePro > /dev/null; then
        log "Installing Source code pro fonts"
        wget https://github.com/adobe-fonts/source-code-pro/archive/2.010R-ro/1.030R-it.zip
        unzip -o 1.030R-it.zip
        smd ~/.fonts
        cp source-code-pro*/OTF/*.otf ~/.fonts
        fc-cache -f -v
        srm 1.030R-it.zip
        srm source-code-pro*
    fi
}

# docker-osx-dev is old, must use docker-machine in future
mac_docker_install() {
    if ! has_cmd docker-osx-dev; then
        log "Installing docker"
        curl -o /usr/local/bin/docker-osx-dev https://raw.githubusercontent.com/brikis98/docker-osx-dev/master/src/docker-osx-dev
        chmod +x /usr/local/bin/docker-osx-dev
        docker-osx-dev install
    fi
}

xmonad_install() {
    if is_linux; then
        if has_cmd cabal; then
            log "Installing xmonad"
            sudo cabal update
            sudo cabal install --global yeganesh

            log "moving ~/.xmonad to $BACKUP_DIR"
            smv ~/.xmonad $BACKUP_DIR

            sclone https://github.com/pervezfunctor/xmonad-config ~/.xmonad

            log "linking ~/.xmonad/bin/xsession to ~/.xinitrc"
            sln ~/.xmonad/bin/xsession ~/.xinitrc
        fi

        if is_ubuntu; then
            log "selecting dmenu.xft as default"
            sudo update-alternatives --set dmenu /usr/bin/dmenu.xft
        fi
    fi
}

additional_install() {
    if is_linux && [ -n "$ADDITIONAL" ]; then
	sourcecodepro_install
        gibo_install
        fasd_install
    else
        mac_docker_install
    fi
    [ -n "$VIM" ] && vim_install
    [ -n "$XMONAD" ] && xmonad_install
}

install_all() {
    [ -n "$ZSH" ] && zsh_install
    [ -n "$BASH" ] && bash_install
    [ -n "$EMACS" ] && emacs_install

    [ -n "$CLOJURE" ] && clojure_install
    [ -n "$WEB" ] && web_install

    [ -n "$PYTHON" ] && python_install
    [ -n "$HASKELL" ] && haskell_install

    [ -n "$RUBY" ] && ruby_install

    if [ -n "$ADDITIONAL" ]; then
        settings
        additional_install
    fi
}

hidpi_conf() {
    local xres=$(xdpyinfo | grep dimensions | uniq | awk '{print $2}' |  cut -d 'x' -f1)
    if [ $xres -ge 2800 ]; then
        gsettings set org.gnome.desktop.interface scaling-factor 2
        gsettings set org.gnome.settings-daemon.plugins.xsettings overrides "{'Gdk/WindowScalingFactor': <2>}"
    fi

    if [ $xres -ge 3840 ]; then
        gsettings set org.gnome.desktop.interface text-scaling-factor .8
    fi
}

gnome_extensions() {
    if has_cmd gsettings && [ -n "$SEARTIPY" ]; then
        gsettings set org.gnome.shell disable-extension-version-validation "true"

        gsettings set org.gnome.shell enabled-extensions "['windowsNavigator@gnome-shell-extensions.gcampax.github.com', 'workspace-indicator@gnome-shell-extensions.gcampax.github.com']"

        wget -O ~/bin/shell-extension-install https://raw.githubusercontent.com/NicolasBernaerts/ubuntu-scripts/master/ubuntugnome/gnome-extension/shell-extension-install
        chmod +x ~/bin/shell-extension-install

        local gnomever=$(gnome-shell --version | awk '{print $3}' | cut -d'.' -f1-2)

        shell-extension-install $gnomever 294 # shellshape
        shell-extension-install $gnomever 97  # coverflow alt-tab
        shell-extension-install $gnomever 442 # drop down terminal
        shell-extension-install $gnomever 413 # app keys
        shell-extension-install $gnomever 361 # emacs manager

        gsettings --schemadir ~/.local/share/gnome-shell/extensions/drop-down-terminal@gs-extensions.zzrough.org/ set org.zzrough.gs-extensions.drop-down-terminal real-shortcut "['F10']"

        gsettings --schemadir ~/.local/share/gnome-shell/extensions/shellshape@gfxmonk.net/data/glib-2.0/schemas set org.gnome.shell.extensions.net.gfxmonk.shellshape.prefs default-layout 'vertical'
    fi
}

gnome_settings() {
    if has_cmd gsettings; then
        dconf write /org/gnome/terminal/legacy/profiles:/:b1dcc9dd-5262-4d8d-a863-c897e6d979b9/login-shell true
        gsettings set org.gnome.Terminal.Legacy.Settings confirm-close false
        gsettings set org.gnome.Terminal.Legacy.Settings menu-accelerator-enabled false
        gsettings set org.gnome.system.locale region 'en_US.UTF-8'
    fi

    if has_cmd gsettings && [ -n "$SEARTIPY" ]; then
        gsettings set org.gnome.desktop.wm.keybindings activate-window-menu "@as []"
        gsettings set org.gnome.desktop.wm.keybindings switch-input-source "@as []"
        gsettings set org.gnome.desktop.wm.keybindings switch-input-source-backward "@as []"
        gsettings set org.gnome.desktop.wm.keybindings switch-applications "['<Alt>Tab']"
        gsettings set org.gnome.settings-daemon.plugins.media-keys screensaver ''
        gsettings set org.gnome.desktop.input-sources xkb-options "['caps:ctrl_modifier', 'ctrl:lctrl_meta']"
        gsettings set org.gnome.desktop.interface gtk-key-theme Emacs

        gsettings set org.gnome.desktop.privacy remove-old-temp-files true
        gsettings set org.gnome.desktop.privacy remove-old-trash-files true
        gsettings set  org.gnome.desktop.screensaver lock-enabled false
        gsettings set  org.gnome.desktop.screensaver ubuntu-lock-on-suspend false
        gsettings set org.gnome.desktop.interface clock-show-date true
        gsettings set org.gnome.Terminal.Legacy.Settings default-show-menubar false
        gsettings set org.gnome.shell.calendar show-weekdate true
        gsettings set org.gnome.SessionManager logout-prompt false

        [ -e ~/.config/gtk-3.0/settings.ini ] || printf "[Settings]\ngtk-application-prefer-dark-theme=1\n" > ~/.config/gtk-3.0/settings.ini
        gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-timeout 1800
        gsettings set org.gnome.desktop.session idle-delay 180
    fi
}

linux_settings() {
    hidpi_conf
    gnome_settings
    gnome_extensions
}

mac_settings() {
    if ! [ -n "$SEARTIPY" ]; then
        return 1
    fi
    # https://github.com/mathiasbynens/dotfiles/blob/978fb2696860ebe055a0caec425c67be0ad73319/.osx

    # Disable Resume system-wide
    defaults write NSGlobalDomain NSQuitAlwaysKeepsWindows -bool false

    # Check for software updates daily, not just once per week
    defaults write com.apple.SoftwareUpdate ScheduleFrequency -int 1


    # Disable Notification Center and remove the menu bar icon
    launchctl unload -w /System/Library/LaunchAgents/com.apple.notificationcenterui.plist

    # Disable smart quotes as they’re annoying when typing code
    defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

    # Disable smart dashes as they’re annoying when typing code
    defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

    # Trackpad: enable tap to click for this user and for the login screen
    defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
    defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
    defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

    # Disable “natural” (Lion-style) scrolling
    defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

    # Increase sound quality for Bluetooth headphones/headsets
    defaults write com.apple.BluetoothAudioAgent "Apple Bitpool Min (editable)" -int 40

    # Disable press-and-hold for keys in favor of key repeat
    defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

    # Set a blazingly fast keyboard repeat rate
    defaults write NSGlobalDomain KeyRepeat -int 0

    # Enable HiDPI display modes (requires restart)
    sudo defaults write /Library/Preferences/com.apple.windowserver DisplayResolutionEnabled -bool true

    # Finder: allow quitting via ⌘ + Q; doing so will also hide desktop icons
    defaults write com.apple.finder QuitMenuItem -bool true

    # Set Desktop as the default location for new Finder windows
    # For other paths, use `PfLo` and `file:///full/path/here/`
    defaults write com.apple.finder NewWindowTarget -string "PfDe"
    defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/Desktop/"

    # Show icons for hard drives, servers, and removable media on the desktop
    defaults write com.apple.finder ShowExternalHardDrivesOnDesktop -bool true
    defaults write com.apple.finder ShowHardDrivesOnDesktop -bool true
    defaults write com.apple.finder ShowMountedServersOnDesktop -bool true
    defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool true

    # Finder: show all filename extensions
    defaults write NSGlobalDomain AppleShowAllExtensions -bool true

    # Avoid creating .DS_Store files on network volumes
    defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true

    # Disable disk image verification
    defaults write com.apple.frameworks.diskimages skip-verify -bool true
    defaults write com.apple.frameworks.diskimages skip-verify-locked -bool true
    defaults write com.apple.frameworks.diskimages skip-verify-remote -bool true

    # Disable the warning before emptying the Trash
    defaults write com.apple.finder WarnOnEmptyTrash -bool false

    # Enable AirDrop over Ethernet and on unsupported Macs running Lion
    defaults write com.apple.NetworkBrowser BrowseAllInterfaces -bool true

    # Show the ~/Library folder
    chflags nohidden ~/Library

    # Set the icon size of Dock items to 36 pixels
    defaults write com.apple.dock tilesize -int 36

    # Minimize windows into their application’s icon
    defaults write com.apple.dock minimize-to-application -bool true

    # Show indicator lights for open applications in the Dock
    defaults write com.apple.dock show-process-indicators -bool true

    # Disable Dashboard
    defaults write com.apple.dashboard mcx-disabled -bool true

    # Don’t show Dashboard as a Space
    defaults write com.apple.dock dashboard-in-overlay -bool true

    # Don’t automatically rearrange Spaces based on most recent use
    defaults write com.apple.dock mru-spaces -bool false

    # Set Safari’s home page to `about:blank` for faster loading
    defaults write com.apple.Safari HomePage -string "about:blank"

    # Prevent Safari from opening ‘safe’ files automatically after downloading
    defaults write com.apple.Safari AutoOpenSafeDownloads -bool false


    # Allow hitting the Backspace key to go to the previous page in history
    defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2BackspaceKeyNavigationEnabled -bool true

    # Disable Safari’s thumbnail cache for History and Top Sites
    defaults write com.apple.Safari DebugSnapshotsUpdatePolicy -int 2

    # Enable Safari’s debug menu
    defaults write com.apple.Safari IncludeInternalDebugMenu -bool true

    # Hide Spotlight tray-icon (and subsequent helper)
    #sudo chmod 600 /System/Library/CoreServices/Search.bundle/Contents/MacOS/Search
    # Disable Spotlight indexing for any volume that gets mounted and has not yet
    # been indexed before.
    # Use `sudo mdutil -i off "/Volumes/foo"` to stop indexing any volume.
    sudo defaults write /.Spotlight-V100/VolumeConfiguration Exclusions -array "/Volumes"
    # Change indexing order and disable some file types
    defaults write com.apple.spotlight orderedItems -array \
             '{"enabled" = 1;"name" = "APPLICATIONS";}' \
             '{"enabled" = 1;"name" = "SYSTEM_PREFS";}' \
             '{"enabled" = 1;"name" = "DIRECTORIES";}' \
             '{"enabled" = 1;"name" = "PDF";}' \
             '{"enabled" = 0;"name" = "DOCUMENTS";}' \
             '{"enabled" = 0;"name" = "EVENT_TODO";}' \
             '{"enabled" = 0;"name" = "BOOKMARKS";}' \
             '{"enabled" = 0;"name" = "MUSIC";}' \
             '{"enabled" = 0;"name" = "MOVIES";}' \
             '{"enabled" = 0;"name" = "PRESENTATIONS";}' \
             '{"enabled" = 0;"name" = "SPREADSHEETS";}' \
             '{"enabled" = 0;"name" = "SOURCE";}'

    # Only use UTF-8 in Terminal.app
    defaults write com.apple.terminal StringEncodings -array 4

    # Don’t display the annoying prompt when quitting iTerm
    defaults write com.googlecode.iterm2 PromptOnQuit -bool false

}

settings() {
    if is_linux; then
        linux_settings
    elif is_mac; then
        mac_settings
    fi
}

select_everything() {
    SCALA="scala"
    CLOJURE="clojure"
    WEB="web"
    PYTHON="python"
    HASKELL="haskell"
    RUBY="ruby"
    CPP="cpp"
    ADDITIONAL="additional"
    VIM="vim"
    XMONAD="xmonad"
    ELIXIR="elixir"
}

script_options() {
    ZSH="zsh"
    BASH="bash"
    EMACS="emacs"
    DOTFILES="dotfiles"

    if [ $# -eq 0 ]; then
        select_everything
    fi

    if [ "$USER" == "pervez" ] || [ "$USER" == "tabrez" ] || [ "$USER" == "wasay" ]; then
        SEARTIPY="seartipy"
    fi

    while [[ $# > 0 ]]; do
        case $1 in
            clojure)
                CLOJURE="clojure"
                shift
                ;;
            scala)
                SCALA="scala"
                shift
                ;;
            web)
                WEB="web"
                shift
                ;;
            nodefaults)
                ZSH=""
                BASH=""
                EMACS=""
                DOTFILES=""
                shift
                ;;
            nozsh)
                ZSH=""
                shift
                ;;
            noemacs)
                EMACS=""
                shift
                ;;
            nobash)
                BASH=""
                shift
                ;;
            nodotfiles)
                DOTFILES=""
                shift
                ;;
            noseartipy)
                SEARTIPY=""
                shift
                ;;
            diagnostics)
                DIAGNOSTICS="diagnostics"
                shift
                ;;
            haskell)
                HASKELL="haskell"
                shift
                ;;
            ruby)
                RUBY="ruby"
                shift
                ;;
            cpp)
                CPP="cpp"
                shift
                ;;
            python)
                PYTHON="python"
                shift
                ;;
            elixir)
                ELIXIR="elixir"
                shift
                ;;
            additional)
                ADDITIONAL="additional"
                VIM="vim"
                shift
                ;;
            xmonad)
                XMONAD="xmonaad"
                shift
                ;;
            seartipy)
                SEARTIPY="seartipy"
                shift
                ;;
            everything)
                select_everything
                shift
                ;;
            *)
                shift # ignore unknown option
                ;;
        esac
    done
}

keep_sudo_running() {
    # Ask for the administrator password upfront
    sudo -v

    # Keep-alive: update existing `sudo` time stamp until `.osx` has finished
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}

setup_backup_dir() {
    BACKUP_DIR=~/seartipy.backups

    if [ -d "$BACKUP_DIR" ]; then
        log "moving $BACKUP_DIR to trash"
        srm $BACKUP_DIR
    fi

    smd $BACKUP_DIR

    if ! [ -d "$BACKUP_DIR" ]; then
        err_exit "cannot create $BACKUP_DIR, quitting"
    fi
}

create_dirs() {
    setup_backup_dir
    smd ~/seartipy/{emacses,vendors}
    smd ~/bin
}

installer() {
    keep_sudo_running

    script_options $*

    if [ -n "$DIAGNOSTICS" ]; then
        post_installer_check
        exit 0
    fi

    echo "Installing $EMACS $ZSH $BASH $SCALA $WEB $CLOJURE $PYTHON $CPP $HASKELL $RUBY $ELIXIR $XMONAD $VIM $ADDITIONAL"

    packages_install

    if is_ubuntu; then
        trash=trash-put
    else
        trash=trash
    fi
    srm ~/seartipy-installer.log  ~/seartipy-error.log ~/seartipy-output.log
    create_dirs

    export PATH="$HOME/bin:$PATH"

    pre_installer_check

    [ -n "$DOTFILES" ] && dotfiles_install
    install_all

    if [ -n "$ZSH" ]; then
        echo "Set zsh as your default shell(this sometimes fails)"
        chsh -s /bin/zsh
    fi

    post_installer_check

    echo "Installation done!"
}

pre_installer_check() {
    pre_cmd_check git
    pre_cmd_check curl
    pre_cmd_check wget
    pre_cmd_check unzip
    pre_cmd_check $trash

    [ -d "$BACKUP_DIR" ] || err_exit "cannot create $BACKUP_DIR, quitting"
    [ -d ~/seartipy/emacses ] || err_exit "cannot create ~/seartipy/emacses, quitting"
    [ -d ~/seartipy/vendors ] || err_exit "cannot create ~/seartipy/vendors, quitting"
    [ -d ~/bin ] || err_exit "~/bin does not exist, quitting"

    [ -n "$EMACS" ] && pre_cmd_check emacs
    [ -n "$ZSH" ] && pre_cmd_check zsh
}

mac_packages_check() {
    cmd_check brew
    cmd_check wget
    cmd_check trash
    cmd_check tree
    cmd_check fasd
    cmd_check unrar
    cmd_check 7z
    cmd_check gpg
    cmd_check ag
    cmd_check greadlink
    cmd_check gibo
    cmd_check gpg

    # TODO: iterm2

    if [ -n "$EMACS" ]; then
        cmd_check emacs
        cmd_check aspell
        cmd_check editorconfig
    fi

    [ -n "$ZSH" ] && cmd_check zsh

    if [ -n "$CLOJURE" ] || [ -n "$SCALA" ]; then
       cmd_check javac # TODO java version 8
    fi

    if [ -n "$SCALA" ]; then
        cmd_check sbt
        cmd_check scala
    fi

    if [ -n "$CLOJURE" ]; then
        cmd_check lein
        cmd_check boot
    fi

    if [ -n "$HASKELL" ]; then
        cmd_check ghc
        cmd_check cabal
    fi

    if [ -n "$WEB" ]; then
        cmd_check npm
        cmd_check flow
    fi

    if [ -n "$CPP" ]; then
        cmd_check cmake
        cmd_check scons
        cmd_check cppcheck
    fi
}


ubuntu_packages_check() {
    if [ -n "$SCALA" ] || [ -n "$CLOJURE" ]; then
        if ! ls /etc/apt/sources.list.d | grep webupd8team-ubuntu-java > /dev/null; then
            warn 'java ppa not added'
        fi
    fi

    if [ -n "$SCALA" ] && ! ls /etc/apt/sources.list.d | grep sbt > /dev/null; then
        warn 'sbt ppa not added'
    fi

    cmd_check curl
    cmd_check wget
    cmd_check git
    cmd_check trash-put
    cmd_check tree
    cmd_check xsel
    cmd_check xclip
    cmd_check ag
    cmd_check unrar
    cmd_check p7zip
    cmd_check dconf
    cmd_check g++
    cmd_check tmux

    if [ -n "$EMACS" ]; then
        cmd_check emacs
        cmd_check aspell
        cmd_check editorconfig
        cmd_check ctags
    fi

    [ -n "$ZSH" ] && cmd_check zsh

    if [ -n "$GIT" ]; then
        cmd_check smartgit kdiff3 meld
    fi

    if [ -n "$VIM" ]; then
        cmd_check vim
    fi

    if [ -n "$CLOJURE" ] || [ -n "$SCALA" ]; then
       cmd_check javac
    fi
    [ -n "$SCALA" ] && cmd_check sbt

    if [ -n "$HASKELL" ]; then
        cmd_check ghc
        cmd_check cabal
        cmd_check stack
    fi

    if [ -n "$CPP" ]; then
        cmd_check clang++
        cmd_check g++
        cmd_check scons
        cmd_check cmake
    fi

    if [ -n "$XMONAD" ]; then
        cmd_check xmonad dmenu
    fi
}

fedora_packages_check() {
    # TODO : rpmfusion check

    cmd_check curl
    cmd_check wget
    cmd_check git
    cmd_check trash
    cmd_check tree
    cmd_check xsel
    cmd_check xclip
    cmd_check ag
    cmd_check unrar
    cmd_check 7za
    cmd_check dconf
    cmd_check tmux

    if [ -n "$EMACS" ]; then
        cmd_check emacs
        cmd_check aspell
        cmd_check ctags
    fi

    [ -n "$ZSH" ] && cmd_check zsh

    if [ -n "$CLOJURE" ] || [ -n "$SCALA" ]; then
       cmd_check javac
    fi

    if [ -n "$GIT" ]; then
        cmd_check kdiff3 meld
    fi

    if [ -n "$VIM" ]; then
        cmd_check vim
    fi

    if [ -n "$SCALA" ]; then
        cmd_check sbt
        cmd_check scala
    fi

    if [ -n "$HASKELL" ]; then
        cmd_check ghc
        cmd_check cabal
        cmd_check stack
    fi

    if [ -n "$CPP" ]; then
        cmd_check clang++
        cmd_check g++
        cmd_check scons
        cmd_check cmake
    fi

    if [ -n "$XMONAD" ]; then
        cmd_check xmonad dmenu
    fi
}

dotfiles_check() {

    dir_check ~/seartipy/dotfiles
    dir_check ~/seartipy/lean-dotfiles

    if [ -n "$ZSH" ]; then
        ln_check ~/seartipy/dotfiles/zshrc ~/.zshrc
        ln_check ~/seartipy/dotfiles/tmux.conf ~/.tmux.conf
    fi

    [ -n "$BASH" ] && ln_check ~/seartipy/dotfiles/bashrc ~/.bash_profile

    if [ -n "$EMACS" ]; then
        dir_check ~/seartipy/emacses/spacemacs
        dir_check ~/seartipy/emacses/housemd
        dir_check ~/seartipy/emacses/lean-emacs

        ln_check ~/seartipy/dotfiles/spacemacs ~/.spacemacs

        ln_check  ~/seartipy/emacses/housemd ~/.emacs.d

        ln_check ~/seartipy/lean-dotfiles/emacs-init.el ~/seartipy/emacses/lean-emacs/init.el
    fi

    if [ -n "$CLOJURE" ]; then
        ln_check ~/seartipy/dotfiles/profiles.clj ~/.lein/profiles.clj
        ln_check ~/seartipy/dotfiles/boot-profile.clj ~/.boot/profile.clj
    fi

    if [ -n "$SCALA" ]; then
        ln_check ~/seartipy/dotfiles/sbt-plugins.sbt ~/.sbt/0.13/plugins/plugins.sbt
        ln_check ~/seartipy/dotfiles/sbt-global.sbt ~/.sbt/0.13/global.sbt
    fi

    if [ -n "$ADDITIONAL" ]; then
        is_mac && ln_check ~/seartipy/dotfiles/amethyst ~/.amethyst
    fi
}

zsh_check() {
    dir_check ~/.slimzsh
    dir_check ~/seartipy/vendors/antigen
    dir_check ~/seartipy/vendors/liquidprompt
}

bash_check() {
    dir_check ~/seartipy/vendors/liquidprompt
}

emacs_check() {
    is_linux && cmd_check cask
}

clojure_check() {
    if is_linux; then
        cmd_check lein
        cmd_check boot
    fi
}

web_check() {
    if is_mac; then
        export PATH=$(npm config get prefix)/bin:$PATH
    fi

    if is_linux; then
        cmd_check nvm
    fi

    cmd_check npm

    if has_cmd npm; then
        cmd_check budo
        cmd_check browserify
        cmd_check watchify
        cmd_check coffee
        cmd_check babel
        cmd_check webpack
        cmd_check eslint
        cmd_check jshint
        cmd_check coffeelint
        cmd_check tern
        cmd_check js-beautify
        cmd_check webpack-dev-server
    fi

}

haskell_check() {
    cmd_check idris
    cmd_check psc

    cmd_check alex
    cmd_check happy
    cmd_check hlint
    cmd_check structured-haskell-mode
    cmd_check stylish-haskell
    cmd_check hasktags
    cmd_check hindent
    cmd_check hdevtools
}

python_check() {
    cmd_check pyenv
    if ! pyenv versions | grep anaconda > /dev/null; then
        warn "anaconda not installed"
    fi
}

ruby_check() {
    cmd_check rvm
    cmd_check pry
    cmd_check sinatra
    cmd_check thin
    cmd_check guard
    cmd_check watchr
    cmd_check tmuxinator
    cmd_check git-up
    cmd_check sass
}

additional_check() {
    if is_linux; then
        cmd_check gibo
        cmd_check fasd
        if ! ls ~/.fonts | grep SourceCodePro > /dev/null; then
            warn "source code pro not installed"
        fi
        cmd_check xmonad
        cmd_check vim
    fi

    if is_mac; then
        cmd_check docker
    fi
}

settings_check() {
    if has_cmd dconf && has_cmd gsettings; then
        [ 'false' == $(dconf read /org/gnome/terminal/legacy/profiles:/:b1dcc9dd-5262-4d8d-a863-c897e6d979b9/login-shell) ] || warn 'terminal not configured to run as login shell'

        [[ 'en_US.UTF-8' == $(gsettings set org.gnome.system.locale region 'en_US.UTF-8') ]] || warn 'system locale not set to en_US UTF8'
    fi
}

post_installer_check() {
    if is_ubuntu; then
        ubuntu_packages_check
    elif is_fedora; then
        fedora_packages_check
    elif is_mac; then
        mac_packages_check
    fi

    dotfiles_check

    [ -n "$ZSH" ] && zsh_check
    [ -n "$BASH" ] && bash_check
    [ -n "$EMACS" ] && emacs_check
    [ -n "$WEB_CHECK" ] && web_check
    [ -n "$HASKELL" ] && haskell_check
    [ -n "$PYTHPN" ] && python_check
    [ -n "$RUBY" ] && ruby_check

    settings_check
}

curdir=`pwd`
installer $* > >(tee ~/seartipy-output.log) 2> >(tee ~/seartipy-error.log >&2)

cd $curdir
