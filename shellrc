#! /bin/bash

BOLD=$(tput bold)
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
RESET=$(tput sgr0)
# WHITE=$(tput setaf 7)

slog() {
    echo "
${BOLD}${GREEN}SEARTIPY: ${RESET} $1
"
}

warn() {
    echo "
${BOLD}${YELLOW}WARNING: ${RESET} $1
"
}

error() {
    echo "
${BOLD}${RED}FATAL : ${RESET} $1
"
}

is_linux() {
    [[ "$OSTYPE" == "linux-gnu" ]]
}

is_debian() {
    has_cmd lsb_release || return 1
    local os
    os=$(lsb_release -i | cut -d ':' -f2)
    [[ "$os" == *"Debian" ]]
}

is_ubuntu() {
    has_cmd lsb_release || return 1
    local os
    os=$(lsb_release -i | cut -d ':' -f2)
    [[ "$os" == *"Ubuntu" ]] || [[ "$os" == *"neon" ]] || [[ "$os" == *"elementary OS" ]] || [[ "$os" == *"LinuxMint" ]]
}

is_apt() {
    is_ubuntu || is_debian
}

is_fedora() {
    [ -f /etc/redhat-release ]
}

is_mac() {
    [[ "$OSTYPE" == "darwin"* ]]
}

has_cmd() {
    command -v "$1" > /dev/null
}

smd() {
    [ -d "$1" ] || mkdir -p "$1"
}

sln() {
    if ! [ -e "$1" ]; then
        warn "$1 does not exist, cannot create the link $2"
        return 1
    elif [ -L "$2" ]; then
        trash "$2"
    elif [ -e "$2" ]; then
        warn "$2 exists and not a symbolic link! not creating link"
        return 1
    fi
    ln -s "$1" "$2"
}

scopy() {
    [ -e "$2" ] || cp "$1" "$2"
}

if is_linux; then
    alias upgrade="sudo apt-get update && sudo apt-get upgrade -y"
    alias pbcopy="xsel --clipboard --input"
    alias pbpaste="xsel --clipboard --output"
    alias open="xdg-open"

    alias tmux="tmux -u -2" #force tmux to use unicode and 256 colors

    #to support xterm key bindings in emacs
    alias e="TERM=xterm-256color emacs -nw"
fi

if is_apt; then
    alias trash=trash-put

    #java
    export JAVA_HOME="/usr/lib/jvm/java-8-oracle"
    export JDK_HOME="/usr/lib/jvm/java-8-oracle"
fi

if is_fedora; then
    alias upgrade="sudo dnf upgrade -y"

    export JAVA_HOME="/etc/alternatives/java_sdk"
    export JDK_HOME="/etc/alternatives/java_sdk"
fi

if is_mac; then
    alias upgrade="brew update && brew upgrade"

    #java
    JAVA_HOME=$(/usr/libexec/java_home -v 1.8 2> /dev/null)
    export JAVA_HOME

    JDK_HOME=$(/usr/libexec/java_home -v 1.8 2> /dev/null)
    export JDK_HOME

    #brew
    export PATH="/usr/local/bin:$PATH"

fi


#haskell
export PATH="$HOME/.cabal/bin:$PATH"

# haskell stack
export PATH="$HOME/.local/bin:$PATH"

#node
export NVM_DIR="$HOME/.nvm"

#python
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"

#emacs
export PATH="$HOME/.cask/bin:$PATH"
export ALTERNATE_EDITOR=""
export EDITOR="emacsclient -t"                  # $EDITOR should open in terminal
export VISUAL="emacsclient -c -a emacs"         # $VISUAL opens in GUI with non-daemon as alternate

export PATH="$HOME/bin:$PATH"

# sources

#node
[ -s "$HOME/.nvm/nvm.sh" ] && source "$HOME/.nvm/nvm.sh"

#python
if has_cmd pyenv > /dev/null; then
    eval "$(pyenv init - --no-rehash)"
    eval "$(pyenv virtualenv-init -)"
fi

seartipy_fix_links() {
    if ! [ -d ~/seartipy/dotfiles ]; then
        smd ~/seartipy
        git clone https://gitlab.com/seartipy/dotfiles.git ~/seartipy/dotfiles
    fi
    if ! [ -d ~/seartipy/dotfiles ]; then
        error "no ~/seartipy/dotfiles, cannot fix links"
    fi

    # bash
    sln ~/seartipy/dotfiles/bashrc ~/.bash_profile
    is_mac && sln ~/seartipy/dotfiles/bashrc ~/.bashrc
    if is_linux && ! grep .bash_profile ~/.bashrc > /dev/null; then
        echo "[ -f ~/.bash_profile ] && source ~/.bash_profile" >> ~/.bashrc
    fi

    # zsh
    has_cmd zsh && sln ~/seartipy/dotfiles/zgen-zshrc ~/.zshrc

    # emacs
    has_cmd emacs && sln ~/seartipy/emacses/housemd ~/.emacs.d

    # clojure
    if has_cmd lein; then
        smd ~/.lein
        sln ~/seartipy/dotfiles/lein-profiles.clj ~/.lein/profiles.clj
    fi

    if has_cmd boot; then
        smd ~/.boot
        sln ~/seartipy/dotfiles/boot-profile.boot ~/.boot/profile.boot
    fi

    # scala
    if has_cmd sbt; then
        smd ~/.sbt/0.13/plugins
        sln ~/seartipy/dotfiles/sbt-plugins.sbt ~/.sbt/0.13/plugins/plugins.sbt
        sln ~/seartipy/dotfiles/sbt-global.sbt ~/.sbt/0.13/global.sbt
    fi


    has_cmd tmux && sln ~/seartipy/dotfiles/tmux.conf ~/.tmux.conf

    is_mac && sln ~/seartipy/dotfiles/amethyst ~/.amethyst

    if has_cmd xmonad; then
        smd ~/.xmonad
        sln ~/seartipy/dotfiles/xmonad.hs ~/.xmonad/xmonad.hs
    fi
}

seartipy_cask_backup() {
    if ! has_cmd cask; then
        warn "cask not installed, cannot backup elpa"
        return 1
    fi

    local ELPA_DIR ELPA_PARENT ELPA_BACKUP ROLLBACK_COUNT OLDEST_BACKUP

    if ! cd ~/seartipy/emacses/housemd; then
        warn "no ~/seartipy/emacses/housemd, cannot backup"
        return 1
    fi

    ELPA_DIR=$(cask package-directory)
    [ -d "$ELPA_DIR" ] || return 1

    ELPA_PARENT=$(dirname "$ELPA_DIR")
    [ -d "$ELPA_PARENT" ] || return 1

    ELPA_BACKUP="${ELPA_PARENT}/elpa-rollback-$(date +"%Y-%m-%d-%H-%M-%S")"

    cp -r "$ELPA_DIR" "$ELPA_BACKUP"

    ROLLBACK_COUNT=$(ls $ELPA_PARENT | grep "^elpa-rollback-" | wc -l | cut -d " " -f 2)

    [ "$ROLLBACK_COUNT" -gt 5 ] || return 1

    OLDEST_BACKUP=$ELPA_PARENT/$(ls -1v "$ELPA_PARENT" | grep "^elpa-rollback" | head -1)
    if [ -d "$OLDEST_BACKUP" ]; then
        trash "$OLDEST_BACKUP"
    else
        warn "cannot trash old backup $OLDEST, as it does not exist. This cannot happen!"
    fi
}

seartipy_cask_rollback() {
    if ! has_cmd cask; then
        warn "cask not installed, cannot rollback elpa"
        return 1
    fi

    if ! cd ~/seartipy/emacses/housemd; then
        warn "no ~/seartipy/emacses/housemd, cannot backup"
        return 1
    fi

    local ELPA_DIR ELPA_PARENT LATEST_BACKUP

    ELPA_DIR=$(cask package-directory)
    [ -d "$ELPA_DIR" ] || return 1

    ELPA_PARENT=$(dirname "$ELPA_DIR")
    [ -d "$ELPA_PARENT" ] || return 1

    LATEST_BACKUP="$(ls -1v "$ELPA_PARENT" | grep "^elpa-rollback" | tail -1)"

    if [ -z "$LATEST_BACKUP" ]; then
        warn "no backups, cannot rollback"
        return 1
    fi

    if ! [ -d "$ELPA_PARENT/${LATEST_BACKUP}" ]; then
        error "no backups available, skipping"
        return 1
    fi

    trash "$ELPA_DIR"

    if [ -d "$ELPA_DIR" ]; then
        warn "cannot trash $ELPA_DIR, can not rolling back"
    elif ! mv "$ELPA_PARENT/$LATEST_BACKUP" "$ELPA_DIR"; then
        error "cannot move $LATEST_BACKUP to $ELPA_DIR; previous $ELPA_DIR must be in trash"
    fi
}

seartipy-gitup() {
    cd "$1" || return 1

    if has_cmd git-up; then
        git-up
    else
        git pull --ff-only
    fi
}

seartipy_upgrade_emacs() {
    seartipy-gitup ~/seartipy/emacses/housemd
    has_cmd cask && seartipy_cask_backup && cd ~/seartipy/emacses/housemd && cask install && cask upgrade-cask
}

seartipy_upgrade_dotfiles() {
    seartipy-gitup ~/seartipy/dotfiles
}

seartipy_upgrade_mean() {
    upgrade
    seartipy_upgrade_dotfiles
    seartipy_upgrade_emacs
    has_cmd zgen && zgen selfupdate && zgen update
    has_cmd zplug && zplug update
}

seartipy_nvm_dist_upgrade() {
    has_cmd nvm || return 1

    cd "$NVM_DIR" && git fetch origin && git checkout "$(git describe --abbrev=0 --tags)"
    cd
    source "$NVM_DIR/nvm.sh"

    nvm install node --reinstall-packages-from=node
    nvm alias default node
}

seartipy_conda_upgrade_all() {
    conda update --all
}

# http://stackoverflow.com/questions/2720014/upgrading-all-packages-with-pip
seartipy_pip_upgrade_all() {
    pip freeze --local | grep -v '^\-e' | cut -d = -f 1  | xargs pip install -U
}

seartipy_gem_upgrade_all() {
    gem update
    gem update --system
}

seartipy_upgrade_all() {
    seartipy_upgrade_mean
    cd && has_cmd sbt && sbt console -batch
    cd && has_cmd lein && lein
    cd && has_cmd npm && npm update -g
    cd && has_cmd cabal && cabal update
    cd && has_cmd stack && stack update
    cd && has_cmd boot && boot -u && boot
    cd && has_cmd stack && stack update
    cd && has_cmd pyenv && pyenv rehash
}

seartipy_emacs_default() {
    sln "$HOME/seartipy/emacses/$1" ~/.emacs.d
}

seartipy_emacs_launch() {
    seartipy_emacs_default "$@"
    is_mac && open -a /Applications/Emacs.app
    is_linux && emacs&
}

seartipy_spacemacs_launch() {
    emacs --no-init-file --eval '(progn (setq user-emacs-directory "~/seartipy/emacses/spacemacs/") (setq spacemacs-start-directory "~/seartipy/emacses/spacemacs/") (load-file (concat spacemacs-start-directory "init.el")))' &
}


seartipy_housemd_launch() {
    emacs --no-init-file  --eval '(progn (setq user-emacs-directory "~/seartipy/emacses/housemd/") (load-file (concat user-emacs-directory "init.el")))' &
}

seartipy_lean_launch() {
    emacs --no-init-file --eval '(progn (setq user-emacs-directory "~/seartipy/emacses/lean-emacs/") (load-file (concat user-emacs-directory "init.el")))' &
}

seartipy_kill_emacs() {
    emacsclient -e "(progn (setq kill-emacs-hook nil) (save-buffers-kill-emacs))"
}

seartipy_ctrl_alt_set() {
    is_linux || return 1
    has_cmd gnome-session && gsettings set org.gnome.desktop.input-sources xkb-options "['caps:ctrl_modifier', 'ctrl:lctrl_meta']"
    has_cmd mate-session && dconf write /org/mate/desktop/peripherals/keyboard/kbd/options "['ctrl\tctrl:lctrl_meta', 'caps\tcaps:ctrl_modifier']"
}

seartipy_ctrl_alt_reset() {
    is_linux || return 1
    has_cmd gnome-session && gsettings set org.gnome.desktop.input-sources xkb-options "@as []"
    has_cmd mate-session && dconf write /org/mate/desktop/peripherals/keyboard/kbd/options '@as []'
}

alias cas=seartipy_ctrl_alt_set
alias car=seartipy_ctrl_alt_reset

alias sse="seartipy_emacs_default spacemacs"
alias sle="seartipy_emacs_default lean-emacs"
alias she="seartipy_emacs_default housemd"

alias es="seartipy_spacemacs_launch"
alias el="seartipy_lean_launch"
alias eh="seartipy_housemd_launch"

alias ec="emacsclient -c -n"
alias et="emacsclient -t"
alias xet="TERM=xterm-256color emacsclient -t"

alias emacs-kill="seartipy_kill_emacs"
alias emacs-restore="seartipy_cask_rollback"

alias upa=seartipy_upgrade_all
alias upm=seartipy_upgrade_mean
alias ups=upgrade
alias upe=seartipy_upgrade_emacs
alias upd=seartipy_upgrade_dotfiles

alias sfl=seartipy_fix_links

alias gst="git status"

if is_apt; then
    alias si="sudo apt-get install -y"
    alias ss="sudo apt-cache search"
    alias sr="sudo apt-get purge"
fi

if is_mac; then
    alias si="brew install"
    alias ss="brew search"
    alias sr="brew uninstall"
fi

if is_fedora; then
    alias si="sudo dnf install -y"
    alias ss="sudo dnf search"
    alias sr="sudo dnf remove"
fi

#THIS MUST BE AT THE END OF THE FILE FOR SDKMAN TO WORK!!!
export SDKMAN_DIR="~/.sdkman"
[[ -s "~/.sdkman/bin/sdkman-init.sh" ]] && source "~/.sdkman/bin/sdkman-init.sh"
